---
# tasks file for zabbix-server
- name: Install Policy Coreutils package
  yum: name=policycoreutils state=present

- name: Install Zabbix key
  #  rpm_key: key=http://repo.zabbix.com/zabbix-official-repo.key state=present
  yum: name={{zbx_server_repo}} state=present

- name: Copy Zabbix Repo Config
  template: src=zabbix.repo.j2 dest=/etc/yum.repos.d/zabbix.repo

- name: Install Zabbix PostgreSQL packages
  yum: name=zabbix-server-pgsql-{{zbx_server_Version}} state=present
  when: zbx_server_PostgreSQL == 1

- name: Install Zabbix Mysql Packages
  yum: name=zabbix-server-mysql-{{zbx_server_Version}} state=present
  when: zbx_server_PostgreSQL == 0

- name: Install Zabbix PostgreSQL Web Packages
  yum: name=zabbix-web-pgsql-{{zbx_server_Version}} state=present
  when: zbx_server_PostgreSQL == 1 and zbx_server_Webserver == 1
  notify: start zabbix-server

- name: Install Zabbix Mysql Web Packages
  yum: name={{item}} state=present
  with_items:
   - zabbix-web-mysql-{{zbx_server_Version}}
  when: zbx_server_PostgreSQL == 0 and zbx_server_Webserver == 1
  notify: start zabbix-server

- name: Copy Zabbix Server Config
  template: src=zabbix_server.conf.j2 dest=/etc/zabbix/zabbix_server.conf

- name: Copy Zabbix Server PHP Config
  template: src=zabbix.conf.j2 dest=/etc/httpd/conf.d/zabbix.conf
  when: zbx_server_Webserver == 1

- name: Copy Zabbix Web frontend Config
  template: src=zabbix.conf.php.j2 dest=/etc/zabbix/web/zabbix.conf.php
  when: zbx_server_Webserver == 1

- name: Install PostgreSQL Database
  include: postgresql.yml
  when: zbx_server_PostgreSQL == 1

- name: Install MySQL Database
  include: mysql.yml
  when: zbx_server_PostgreSQL == 0

- name: Configure SELinux Policy httpd
  command: setsebool -P httpd_can_network_connect on
  when: ansible_selinux

- name: Configure SELinux Policy httpd can connect db
  command: setsebool -P httpd_can_network_connect_db on
  when: ansible_selinux

- name: Configure SELinux Policy zabbix
  command: setsebool -P zabbix_can_network on
  when: ansible_selinux

- name: Open the IPTables port 10051 on Zabbix-Server
  lineinfile: dest=/etc/sysconfig/iptables
            regexp="^-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT$"
            line="-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT"
            insertafter="^:OUTPUT ACCEPT \[\d*:\d*\]$"
  with_items:
    - { protocol: tcp, port: 10051 }
  notify:
    - restart iptables

- name: Open the IPTables port 80 on Zabbix-Server
  lineinfile: dest=/etc/sysconfig/iptables
            regexp="^-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT$"
            line="-A INPUT -p {{item.protocol}} -m {{item.protocol}} --dport {{item.port}} -j ACCEPT"
            insertafter="^:OUTPUT ACCEPT \[\d*:\d*\]$"
  with_items:
    - { protocol: tcp, port: 80 }


  notify:
    - start zabbix-server

  notify:
    - restart iptables
  when: zbx_server_Webserver == 1

  notify:
    - restart httpd
  when: zbx_server_Webserver == 1
